/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// File Upload HTTP Protocol
// Rob Dobson 2021
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include <FileUploadHTTPProtocol.h>
#include <Logger.h>
#include <RICRESTMsg.h>

// Log prefix
static const char *MODULE_PREFIX = "FileUpHTTP";

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Constructor
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

FileUploadHTTPProtocol::FileUploadHTTPProtocol(FileStreamBlockWriteFnType fileBlockWrite, 
            FileStreamBlockReadFnType fileBlockRead,
            FileStreamGetCRCFnType fileGetCRC,
            FileStreamCancelEndFnType fileCancelEnd,
            CommsCoreIF* pCommsCore,
            FileStreamBase::FileStreamContentType fileStreamContentType, 
            FileStreamBase::FileStreamFlowType fileStreamFlowType,
            uint32_t streamID, 
            uint32_t fileStreamLength,
            const char* fileStreamName) :
    FileStreamBase(fileBlockWrite, fileBlockRead, fileGetCRC, fileCancelEnd, 
            pCommsCore,
            fileStreamContentType, fileStreamFlowType, 
            streamID, fileStreamLength, fileStreamName)
{
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Service
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void FileUploadHTTPProtocol::service()
{
    // Nothing to do
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Handle command frame
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

RaftRetCode FileUploadHTTPProtocol::handleCmdFrame(FileStreamBase::FileStreamMsgType fsMsgType, 
                const RICRESTMsg& ricRESTReqMsg, String& respMsg, 
                const CommsChannelMsg &endpointMsg)
{
    // Unexpected message
    LOG_W(MODULE_PREFIX, "handleCmdFrame UNEXPECTED req %s", ricRESTReqMsg.getReq().c_str());

    return RaftRetCode::RAFT_INVALID_OPERATION;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Handle data frame (file/stream block)
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

RaftRetCode FileUploadHTTPProtocol::handleDataFrame(const RICRESTMsg& ricRESTReqMsg, String& respMsg)
{
#ifdef DEBUG_FILE_STREAM_BLOCK_DETAIL
    LOG_I(MODULE_PREFIX, "handleDataFrame isUploading %d msgLen %d expectedPos %d", 
            _isUploading, ricRESTReqMsg.getBinLen(), _expectedFilePos);
#endif
    // HTTP protocol handles the file upload in the HTTP POST body
    return RaftRetCode::RAFT_INVALID_OPERATION;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Get debug str
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

String FileUploadHTTPProtocol::getDebugJSON(bool includeBraces)
{
    return "{}";
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Is Active
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool FileUploadHTTPProtocol::isActive()
{
    return false;
}
